[1mdiff --git a/android/app/src/main/AndroidManifest.xml b/android/app/src/main/AndroidManifest.xml[m
[1mindex ca83e23..0acf4d7 100644[m
[1m--- a/android/app/src/main/AndroidManifest.xml[m
[1m+++ b/android/app/src/main/AndroidManifest.xml[m
[36m@@ -3,6 +3,25 @@[m
     <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>[m
     <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>[m
     <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />[m
[32m+[m[41m    [m
[32m+[m[32m    <!-- Bluetooth permissions -->[m
[32m+[m[32m    <uses-permission android:name="android.permission.BLUETOOTH" />[m
[32m+[m[32m    <uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />[m
[32m+[m[41m    [m
[32m+[m[32m    <!-- For Android 12+ (API level 31+) -->[m
[32m+[m[32m    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT"[m[41m [m
[32m+[m[32m                     android:usesPermissionFlags="neverForLocation" />[m
[32m+[m[32m    <uses-permission android:name="android.permission.BLUETOOTH_SCAN"[m[41m [m
[32m+[m[32m                     android:usesPermissionFlags="neverForLocation" />[m
[32m+[m[32m    <uses-permission android:name="android.permission.BLUETOOTH_ADVERTISE" />[m
[32m+[m[41m    [m
[32m+[m[32m    <!-- Bluetooth features -->[m
[32m+[m[32m    <uses-feature android:name="android.hardware.bluetooth" android:required="true" />[m
[32m+[m[32m    <uses-feature android:name="android.hardware.bluetooth_le" android:required="true" />[m
[32m+[m[41m    [m
[32m+[m[32m    <!-- Storage permissions (if needed for your app) -->[m
[32m+[m[32m    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />[m
[32m+[m[32m    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />[m
 [m
 [m
     <application[m
[1mdiff --git a/lib/users/bikestatus.dart b/lib/users/bikestatus.dart[m
[1mindex 1fefe17..3bac1d9 100644[m
[1m--- a/lib/users/bikestatus.dart[m
[1m+++ b/lib/users/bikestatus.dart[m
[36m@@ -1,5 +1,8 @@[m
 import 'package:flutter/material.dart';[m
 import 'package:google_maps_flutter/google_maps_flutter.dart';[m
[32m+[m[32mimport 'package:permission_handler/permission_handler.dart';[m
[32m+[m[32mimport 'package:flutter_blue_plus/flutter_blue_plus.dart';[m
[32m+[m[32mimport 'device_list_page.dart';[m
 import 'dart:convert';[m
 import 'package:http/http.dart' as http;[m
 [m
[36m@@ -10,6 +13,8 @@[m [mclass Bikestatus extends StatefulWidget {[m
 [m
 class _BikestatusState extends State<Bikestatus> {[m
   bool isBluetoothConnected = false;[m
[32m+[m[32m  bool isScanning = false;[m
[32m+[m[32m  BluetoothDevice? connectedDevice;[m
   bool _locationEnabled = false;[m
   bool isRideMode = false;[m
   GoogleMapController? _mapController;[m
[36m@@ -35,6 +40,10 @@[m [mclass _BikestatusState extends State<Bikestatus> {[m
 [m
   @override[m
   void dispose() {[m
[32m+[m[32m    // Disconnect from device if connected[m
[32m+[m[32m    if (connectedDevice != null) {[m
[32m+[m[32m      connectedDevice!.disconnect();[m
[32m+[m[32m    }[m
     _mapController?.dispose();[m
     super.dispose();[m
   }[m
[36m@@ -69,39 +78,84 @@[m [mclass _BikestatusState extends State<Bikestatus> {[m
               children: [[m
                 // Bluetooth card[m
                 Container([m
[31m-                  padding: EdgeInsets.all(12),[m
[31m-                  decoration: BoxDecoration([m
[31m-                    color: Color(0xFFC5CAE9),[m
[31m-                    borderRadius: BorderRadius.circular(12),[m
[31m-                    border: Border.all(color: Colors.indigo.shade100),[m
[31m-                  ),[m
[31m-                  child: Row([m
[31m-                    children: [[m
[31m-                      Icon(Icons.bluetooth, color: Colors.black, size: 28),[m
[31m-                      SizedBox(width: 12),[m
[31m-                      Expanded([m
[31m-                        child: Text([m
[31m-                          isBluetoothConnected[m
[31m-                              ? "Bluetooth Connected"[m
[31m-                              : "Tap to Pair with Bike",[m
[31m-                          style: TextStyle(fontWeight: FontWeight.w600),[m
[31m-                        ),[m
[31m-                      ),[m
[31m-                      TextButton([m
[31m-                        onPressed: () {[m
[31m-                          setState(() {[m
[31m-                            isBluetoothConnected = true;[m
[31m-                          });[m
[31m-                        },[m
[31m-                        child: Text("Pair"),[m
[32m+[m[32m                padding: EdgeInsets.all(12),[m
[32m+[m[32m                decoration: BoxDecoration([m
[32m+[m[32m                  color: Color(0xFFC5CAE9),[m
[32m+[m[32m                  borderRadius: BorderRadius.circular(12),[m
[32m+[m[32m                  border: Border.all(color: Colors.indigo.shade100),[m
[32m+[m[32m                ),[m
[32m+[m[32m                child: Row([m
[32m+[m[32m                  children: [[m
[32m+[m[32m                    Icon(Icons.bluetooth, color: Colors.black, size: 28),[m
[32m+[m[32m                    SizedBox(width: 12),[m
[32m+[m[32m                    Expanded([m
[32m+[m[32m                      child: Text([m
[32m+[m[32m                        isBluetoothConnected[m
[32m+[m[32m                            ? "Connected to ${connectedDevice?.platformName ?? 'Device'}"[m
[32m+[m[32m                            : "Tap to Pair with Bike",[m
[32m+[m[32m                        style: TextStyle(fontWeight: FontWeight.w600),[m
                       ),[m
[31m-                    ],[m
[31m-                  ),[m
[32m+[m[32m                    ),[m
[32m+[m[32m                    TextButton([m
[32m+[m[32m                      onPressed: isScanning ? null : () async {[m
[32m+[m[32m                        if (isBluetoothConnected && connectedDevice != null) {[m
[32m+[m[32m                          // Disconnect from current device[m
[32m+[m[32m                          try {[m
[32m+[m[32m                            await connectedDevice!.disconnect();[m
[32m+[m[32m                            setState(() {[m
[32m+[m[32m                              isBluetoothConnected = false;[m
[32m+[m[32m                              connectedDevice = null;[m
[32m+[m[32m                            });[m
[32m+[m[32m                            print("Disconnected from device");[m
[32m+[m[32m                          } catch (e) {[m
[32m+[m[32m                            print("Error disconnecting: $e");[m
[32m+[m[32m                          }[m
[32m+[m[32m                        } else {[m
[32m+[m[32m                          // Navigate to device list page[m
[32m+[m[32m                          final result = await Navigator.push([m
[32m+[m[32m                            context,[m
[32m+[m[32m                            MaterialPageRoute(builder: (context) => DeviceListPage()),[m
[32m+[m[32m                          );[m
[32m+[m[41m                          [m
[32m+[m[32m                          // Handle the result from device list page[m
[32m+[m[32m                          if (result != null && result['connected'] == true) {[m
[32m+[m[32m                            setState(() {[m
[32m+[m[32m                              isBluetoothConnected = true;[m
[32m+[m[32m                              connectedDevice = result['device'];[m
[32m+[m[32m                            });[m
[32m+[m[41m                            [m
[32m+[m[32m                            // Discover services for the connected device[m
[32m+[m[32m                            try {[m
[32m+[m[32m                              List<BluetoothService> services = await result['device'].discoverServices();[m
[32m+[m[32m                              print("Discovered ${services.length} services for ${result['device'].platformName}");[m
[32m+[m[41m                              [m
[32m+[m[32m                              for (BluetoothService service in services) {[m
[32m+[m[32m                                print("Service UUID: ${service.uuid}");[m
[32m+[m[32m                                for (BluetoothCharacteristic characteristic in service.characteristics) {[m
[32m+[m[32m                                  print("  Characteristic UUID: ${characteristic.uuid}");[m
[32m+[m[32m                                }[m
[32m+[m[32m                              }[m
[32m+[m[32m                            } catch (e) {[m
[32m+[m[32m                              print("Error discovering services: $e");[m
[32m+[m[32m                            }[m
[32m+[m[32m                          }[m
[32m+[m[32m                        }[m
[32m+[m[32m                      },[m
[32m+[m[32m                      child: isScanning[m[41m [m
[32m+[m[32m                        ? SizedBox([m
[32m+[m[32m                            width: 16,[m
[32m+[m[32m                            height: 16,[m
[32m+[m[32m                            child: CircularProgressIndicator(strokeWidth: 2),[m
[32m+[m[32m                          )[m
[32m+[m[32m                        : Text(isBluetoothConnected ? "Disconnect" : "Pair"),[m
[32m+[m[32m                    ),[m
[32m+[m[32m                  ],[m
                 ),[m
[32m+[m[32m              ),[m
 [m
[31m-                SizedBox(height: 20),[m
[32m+[m[32m              SizedBox(height: 20),[m
 [m
[31m-                // Google Map[m
[32m+[m[32m              // Google Map[m
                 ClipRRect([m
                   borderRadius: BorderRadius.circular(15),[m
                   child: SizedBox([m
[36m@@ -275,6 +329,183 @@[m [mclass _BikestatusState extends State<Bikestatus> {[m
     );[m
   }[m
 [m
[32m+[m[32m  Future<void> connectToDevice(BluetoothDevice device) async {[m
[32m+[m[32m    try {[m
[32m+[m[32m      print("Attempting to connect to ${device.platformName}");[m
[32m+[m[41m      [m
[32m+[m[32m      // Connect to the device[m
[32m+[m[32m      await device.connect(timeout: Duration(seconds: 15));[m
[32m+[m[32m      print("Connected to ${device.platformName}");[m
[32m+[m[41m      [m
[32m+[m[32m      // Update UI state[m
[32m+[m[32m      setState(() {[m
[32m+[m[32m        isBluetoothConnected = true;[m
[32m+[m[32m        connectedDevice = device;[m
[32m+[m[32m      });[m
[32m+[m[41m      [m
[32m+[m[32m      // Discover services[m
[32m+[m[32m      List<BluetoothService> services = await device.discoverServices();[m
[32m+[m[32m      print("Discovered ${services.length} services");[m
[32m+[m[41m      [m
[32m+[m[32m      for (BluetoothService service in services) {[m
[32m+[m[32m        print("Service UUID: ${service.uuid}");[m
[32m+[m[32m        for (BluetoothCharacteristic characteristic in service.characteristics) {[m
[32m+[m[32m          print("  Characteristic UUID: ${characteristic.uuid}");[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m[41m      [m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      print("Error connecting to device: $e");[m
[32m+[m[32m      setState(() {[m
[32m+[m[32m        isBluetoothConnected = false;[m
[32m+[m[32m        connectedDevice = null;[m
[32m+[m[32m      });[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Future<void> connectBLE() async {[m
[32m+[m[32m    try {[m
[32m+[m[32m      // Check if Bluetooth is supported and enabled[m
[32m+[m[32m      if (await FlutterBluePlus.isSupported == false) {[m
[32m+[m[32m        print("Bluetooth not supported by this device");[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // Request Bluetooth permissions[m
[32m+[m[32m      var bluetoothStatus = await Permission.bluetooth.status;[m
[32m+[m[32m      var locationStatus = await Permission.location.status;[m
[32m+[m[32m      var bluetoothScanStatus = await Permission.bluetoothScan.status;[m
[32m+[m[32m      var bluetoothConnectStatus = await Permission.bluetoothConnect.status;[m
[32m+[m[41m      [m
[32m+[m[32m      print("Current permissions - Bluetooth: $bluetoothStatus, Location: $locationStatus, Scan: $bluetoothScanStatus, Connect: $bluetoothConnectStatus");[m
[32m+[m[41m      [m
[32m+[m[32m      if (bluetoothStatus.isDenied || locationStatus.isDenied ||[m[41m [m
[32m+[m[32m          bluetoothScanStatus.isDenied || bluetoothConnectStatus.isDenied) {[m
[32m+[m[32m        // Request permissions[m
[32m+[m[32m        Map<Permission, PermissionStatus> statuses = await [[m
[32m+[m[32m          Permission.bluetooth,[m
[32m+[m[32m          Permission.bluetoothConnect,[m
[32m+[m[32m          Permission.bluetoothScan,[m
[32m+[m[32m          Permission.location,[m
[32m+[m[32m          Permission.locationWhenInUse, // Add this for better location access[m
[32m+[m[32m        ].request();[m
[32m+[m[41m        [m
[32m+[m[32m        print("Permission statuses after request: $statuses");[m
[32m+[m[41m        [m
[32m+[m[32m        // Check if essential permissions were granted[m
[32m+[m[32m        if (statuses[Permission.bluetoothScan] != PermissionStatus.granted ||[m
[32m+[m[32m            statuses[Permission.location] != PermissionStatus.granted) {[m
[32m+[m[32m          print("Required permissions not granted for BLE scanning");[m
[32m+[m[32m          return;[m
[32m+[m[32m        }[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // Check if Bluetooth is turned on[m
[32m+[m[32m      var bluetoothState = await FlutterBluePlus.adapterState.first;[m
[32m+[m[32m      print("Bluetooth adapter state: $bluetoothState");[m
[32m+[m[32m      if (bluetoothState != BluetoothAdapterState.on) {[m
[32m+[m[32m        print("Bluetooth is not turned on");[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      print("Starting BLE scan...");[m
[32m+[m[41m      [m
[32m+[m[32m      // Declare subscription variable[m
[32m+[m[32m      late var subscription;[m
[32m+[m[41m      [m
[32m+[m[32m      // Start scanning with more aggressive settings[m
[32m+[m[32m      await FlutterBluePlus.startScan([m
[32m+[m[32m        timeout: Duration(seconds: 20), // Longer timeout[m
[32m+[m[32m        withServices: [], // Scan for all devices[m
[32m+[m[32m        withRemoteIds: [], // Empty list to scan for all devices[m
[32m+[m[32m        withNames: [], // Empty list to scan for all device names[m
[32m+[m[32m        continuousUpdates: true, // Get continuous updates[m
[32m+[m[32m        continuousDivisor: 1, // Update frequency[m
[32m+[m[32m      );[m
[32m+[m[41m      [m
[32m+[m[32m      // Listen for scan results with immediate processing[m
[32m+[m[32m      subscription = FlutterBluePlus.scanResults.listen((results) async {[m
[32m+[m[32m        if (results.isNotEmpty) {[m
[32m+[m[32m          print("Scan results received: ${results.length} devices found");[m
[32m+[m[41m          [m
[32m+[m[32m          for (ScanResult result in results) {[m
[32m+[m[32m            var device = result.device;[m
[32m+[m[32m            var rssi = result.rssi;[m
[32m+[m[32m            var name = device.platformName.isNotEmpty ? device.platformName : "Unknown Device";[m
[32m+[m[32m            var advertisementData = result.advertisementData;[m
[32m+[m[41m            [m
[32m+[m[32m            print('Found device: $name (${device.remoteId}) RSSI: $rssi');[m
[32m+[m[32m            print('  Local Name: ${advertisementData.localName}');[m
[32m+[m[32m            print('  Manufacturer Data: ${advertisementData.manufacturerData}');[m
[32m+[m[32m            print('  Service UUIDs: ${advertisementData.serviceUuids}');[m
[32m+[m[41m            [m
[32m+[m[32m            // More flexible device filtering - you can adjust this based on your bike's characteristics[m
[32m+[m[32m            bool isPotentialBike = false;[m
[32m+[m[41m            [m
[32m+[m[32m            // Check by name (case-insensitive)[m
[32m+[m[32m            if (name.toLowerCase().contains('bike') ||[m[41m [m
[32m+[m[32m                name.toLowerCase().contains('spinlock') ||[m
[32m+[m[32m                name.toLowerCase().contains('lock') ||[m
[32m+[m[32m                advertisementData.localName.toLowerCase().contains('bike') ||[m
[32m+[m[32m                advertisementData.localName.toLowerCase().contains('spinlock')) {[m
[32m+[m[32m              isPotentialBike = true;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            // You can also check by service UUIDs if you know them[m
[32m+[m[32m            // if (advertisementData.serviceUuids.contains('your-bike-service-uuid')) {[m
[32m+[m[32m            //   isPotentialBike = true;[m
[32m+[m[32m            // }[m
[32m+[m[41m            [m
[32m+[m[32m            // For testing purposes, you might want to try connecting to any device with a strong signal[m
[32m+[m[32m            // Uncomment the line below to try connecting to any nearby device (be careful!)[m
[32m+[m[32m            // if (rssi > -60) isPotentialBike = true;[m
[32m+[m[41m            [m
[32m+[m[32m            // TEMPORARY: For debugging, let's try to connect to the first device we find[m
[32m+[m[32m            // Remove this when you know your bike's name/characteristics[m
[32m+[m[32m            if (results.isNotEmpty && isPotentialBike == false && rssi > -70) {[m
[32m+[m[32m              print("DEBUG: Attempting to connect to first available device for testing");[m
[32m+[m[32m              isPotentialBike = true;[m
[32m+[m[32m            }[m
[32m+[m[41m            [m
[32m+[m[32m            if (isPotentialBike) {[m
[32m+[m[32m              print("Found potential bike device: $name");[m
[32m+[m[32m              // Stop scanning before connecting[m
[32m+[m[32m              await FlutterBluePlus.stopScan();[m
[32m+[m[32m              subscription.cancel();[m
[32m+[m[32m              // Attempt to connect to the bike device[m
[32m+[m[32m              await connectToDevice(device);[m
[32m+[m[32m              return; // Exit the function after attempting connection[m
[32m+[m[32m            }[m
[32m+[m[32m          }[m
[32m+[m[32m        } else {[m
[32m+[m[32m          print("Scan results received: 0 devices found - continuing scan...");[m
[32m+[m[32m        }[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // Wait for scan to complete[m
[32m+[m[32m      await Future.delayed(Duration(seconds: 20));[m
[32m+[m[41m      [m
[32m+[m[32m      // Stop scanning if still running[m
[32m+[m[32m      if (FlutterBluePlus.isScanningNow) {[m
[32m+[m[32m        await FlutterBluePlus.stopScan();[m
[32m+[m[32m      }[m
[32m+[m[32m      subscription.cancel();[m
[32m+[m[41m      [m
[32m+[m[32m      print("BLE scan completed");[m
[32m+[m[41m      [m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      print("Error in connectBLE: $e");[m
[32m+[m[32m      // Make sure to stop scanning if there's an error[m
[32m+[m[32m      try {[m
[32m+[m[32m        if (FlutterBluePlus.isScanningNow) {[m
[32m+[m[32m          await FlutterBluePlus.stopScan();[m
[32m+[m[32m        }[m
[32m+[m[32m      } catch (stopError) {[m
[32m+[m[32m        print("Error stopping scan: $stopError");[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
   /// Fetch bike location from API[m
   Future<void> _fetchBikeLocation() async {[m
     final url = Uri.parse("http://192.168.8.146/telemetry/latest/BIKE000000");[m
[36m@@ -329,4 +560,4 @@[m [mclass _BikestatusState extends State<Bikestatus> {[m
       print("Error fetching bike health: $e");[m
     }[m
   }[m
[31m-}[m
[32m+[m[32m}[m
\ No newline at end of file[m
[1mdiff --git a/lib/users/device_list_page.dart b/lib/users/device_list_page.dart[m
[1mnew file mode 100644[m
[1mindex 0000000..d3c3f51[m
[1m--- /dev/null[m
[1m+++ b/lib/users/device_list_page.dart[m
[36m@@ -0,0 +1,575 @@[m
[32m+[m[32mimport 'package:flutter/material.dart';[m
[32m+[m[32mimport 'package:flutter_blue_plus/flutter_blue_plus.dart';[m
[32m+[m[32mimport 'package:permission_handler/permission_handler.dart';[m
[32m+[m
[32m+[m[32mclass DeviceListPage extends StatefulWidget {[m
[32m+[m[32m  @override[m
[32m+[m[32m  State<DeviceListPage> createState() => _DeviceListPageState();[m
[32m+[m[32m}[m
[32m+[m
[32m+[m[32mclass _DeviceListPageState extends State<DeviceListPage> {[m
[32m+[m[32m  List<ScanResult> devices = [];[m
[32m+[m[32m  bool isScanning = false;[m
[32m+[m[32m  var subscription;[m
[32m+[m
[32m+[m[32m  @override[m
[32m+[m[32m  void initState() {[m
[32m+[m[32m    super.initState();[m
[32m+[m[32m    startScanning();[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  @override[m
[32m+[m[32m  void dispose() {[m
[32m+[m[32m    stopScanning();[m
[32m+[m[32m    super.dispose();[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Future<void> startScanning() async {[m
[32m+[m[32m    try {[m
[32m+[m[32m      setState(() {[m
[32m+[m[32m        isScanning = true;[m
[32m+[m[32m        devices.clear();[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // Check permissions and Bluetooth state[m
[32m+[m[32m      if (await FlutterBluePlus.isSupported == false) {[m
[32m+[m[32m        print("Bluetooth not supported by this device");[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // Request permissions[m
[32m+[m[32m      await [[m
[32m+[m[32m        Permission.bluetooth,[m
[32m+[m[32m        Permission.bluetoothConnect,[m
[32m+[m[32m        Permission.bluetoothScan,[m
[32m+[m[32m        Permission.location,[m
[32m+[m[32m        Permission.locationWhenInUse,[m
[32m+[m[32m      ].request();[m
[32m+[m
[32m+[m[32m      // Check if Bluetooth is turned on[m
[32m+[m[32m      var bluetoothState = await FlutterBluePlus.adapterState.first;[m
[32m+[m[32m      if (bluetoothState != BluetoothAdapterState.on) {[m
[32m+[m[32m        print("Bluetooth is not turned on");[m
[32m+[m[32m        return;[m
[32m+[m[32m      }[m
[32m+[m
[32m+[m[32m      // Start scanning[m
[32m+[m[32m      await FlutterBluePlus.startScan([m
[32m+[m[32m        timeout: Duration(seconds: 30),[m
[32m+[m[32m        withServices: [],[m
[32m+[m[32m        withRemoteIds: [],[m
[32m+[m[32m        withNames: [],[m
[32m+[m[32m        continuousUpdates: true,[m
[32m+[m[32m        continuousDivisor: 1,[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      // Listen for scan results[m
[32m+[m[32m      subscription = FlutterBluePlus.scanResults.listen((results) {[m
[32m+[m[32m        setState(() {[m
[32m+[m[32m          // Update device list efficiently[m
[32m+[m[32m          for (ScanResult result in results) {[m
[32m+[m[32m            // Check if device already exists[m
[32m+[m[32m            int existingIndex = devices.indexWhere((existing) =>[m[41m [m
[32m+[m[32m              existing.device.remoteId == result.device.remoteId);[m
[32m+[m[41m            [m
[32m+[m[32m            if (existingIndex != -1) {[m
[32m+[m[32m              // Update existing device with new scan result[m
[32m+[m[32m              devices[existingIndex] = result;[m
[32m+[m[32m            } else {[m
[32m+[m[32m              // Add new device[m
[32m+[m[32m              devices.add(result);[m
[32m+[m[32m            }[m
[32m+[m[32m          }[m
[32m+[m[41m          [m
[32m+[m[32m          // Sort devices: potential bikes first, then by RSSI[m
[32m+[m[32m          devices.sort((a, b) {[m
[32m+[m[32m            // Check if devices are potential bikes[m
[32m+[m[32m            bool aIsBike = _isPotentialBike(a);[m
[32m+[m[32m            bool bIsBike = _isPotentialBike(b);[m
[32m+[m[41m            [m
[32m+[m[32m            if (aIsBike && !bIsBike) return -1;[m
[32m+[m[32m            if (!aIsBike && bIsBike) return 1;[m
[32m+[m[41m            [m
[32m+[m[32m            // If both are bikes or both are not bikes, sort by RSSI[m
[32m+[m[32m            return b.rssi.compareTo(a.rssi);[m
[32m+[m[32m          });[m
[32m+[m[32m        });[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m      // Auto-stop scanning after timeout[m
[32m+[m[32m      await Future.delayed(Duration(seconds: 30));[m
[32m+[m[32m      stopScanning();[m
[32m+[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      print("Error in scanning: $e");[m
[32m+[m[32m      setState(() {[m
[32m+[m[32m        isScanning = false;[m
[32m+[m[32m      });[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  void stopScanning() {[m
[32m+[m[32m    try {[m
[32m+[m[32m      if (FlutterBluePlus.isScanningNow) {[m
[32m+[m[32m        FlutterBluePlus.stopScan();[m
[32m+[m[32m      }[m
[32m+[m[32m      if (subscription != null) {[m
[32m+[m[32m        subscription.cancel();[m
[32m+[m[32m      }[m
[32m+[m[32m      setState(() {[m
[32m+[m[32m        isScanning = false;[m
[32m+[m[32m      });[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      print("Error stopping scan: $e");[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  bool _isPotentialBike(ScanResult result) {[m
[32m+[m[32m    var device = result.device;[m
[32m+[m[32m    var advertisementData = result.advertisementData;[m
[32m+[m[41m    [m
[32m+[m[32m    // Get the best available name[m
[32m+[m[32m    String deviceName = device.platformName.isNotEmpty ? device.platformName :[m[41m [m
[32m+[m[32m                       (advertisementData.localName.isNotEmpty ? advertisementData.localName : "Unknown Device");[m
[32m+[m[41m    [m
[32m+[m[32m    String searchText = "${deviceName.toLowerCase()} ${advertisementData.localName.toLowerCase()}";[m
[32m+[m[41m    [m
[32m+[m[32m    // Check by name[m
[32m+[m[32m    if (searchText.contains('bike') ||[m[41m [m
[32m+[m[32m        searchText.contains('spinlock') ||[m
[32m+[m[32m        searchText.contains('lock') ||[m
[32m+[m[32m        searchText.contains('cycle') ||[m
[32m+[m[32m        searchText.contains('ebike') ||[m
[32m+[m[32m        searchText.contains('scooter')) {[m
[32m+[m[32m      return true;[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    // Check service UUIDs for common bike/fitness services[m
[32m+[m[32m    for (var serviceUuid in advertisementData.serviceUuids) {[m
[32m+[m[32m      String uuid = serviceUuid.toString().toLowerCase();[m
[32m+[m[32m      if (uuid.contains('1816') || // Cycling Speed and Cadence[m
[32m+[m[32m          uuid.contains('1818') || // Cycling Power[m
[32m+[m[32m          uuid.contains('180f') || // Battery Service[m
[32m+[m[32m          uuid.contains('1826')) { // Fitness Machine Service[m
[32m+[m[32m        return true;[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m[41m    [m
[32m+[m[32m    return false;[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Future<void> showDeviceDetails(ScanResult result) async {[m
[32m+[m[32m    var device = result.device;[m
[32m+[m[32m    var advertisementData = result.advertisementData;[m
[32m+[m[41m    [m
[32m+[m[32m    showDialog([m
[32m+[m[32m      context: context,[m
[32m+[m[32m      builder: (context) => AlertDialog([m
[32m+[m[32m        title: Text("Device Details"),[m
[32m+[m[32m        content: SingleChildScrollView([m
[32m+[m[32m          child: Column([m
[32m+[m[32m            crossAxisAlignment: CrossAxisAlignment.start,[m
[32m+[m[32m            mainAxisSize: MainAxisSize.min,[m
[32m+[m[32m            children: [[m
[32m+[m[32m              _buildDetailRow("Platform Name", device.platformName.isEmpty ? "Not advertised" : device.platformName),[m
[32m+[m[32m              _buildDetailRow("Local Name", advertisementData.localName.isEmpty ? "Not advertised" : advertisementData.localName),[m
[32m+[m[32m              _buildDetailRow("Device ID", device.remoteId.toString()),[m
[32m+[m[32m              _buildDetailRow("RSSI", "${result.rssi} dBm"),[m
[32m+[m[32m              _buildDetailRow("Connectable", advertisementData.connectable ? "Yes" : "No"),[m
[32m+[m[32m              _buildDetailRow("TX Power", advertisementData.txPowerLevel?.toString() ?? "Not available"),[m
[32m+[m[41m              [m
[32m+[m[32m              SizedBox(height: 12),[m
[32m+[m[32m              Text("Name Visibility:", style: TextStyle(fontWeight: FontWeight.bold, color: Colors.blue.shade800)),[m
[32m+[m[32m              Padding([m
[32m+[m[32m                padding: EdgeInsets.only(left: 16, top: 4),[m
[32m+[m[32m                child: Text([m
[32m+[m[32m                  "â€¢ Platform Name: ${device.platformName.isEmpty ? 'âŒ Hidden/Not set' : 'âœ… Visible'}\n"[m
[32m+[m[32m                  "â€¢ Local Name: ${advertisementData.localName.isEmpty ? 'âŒ Hidden/Not set' : 'âœ… Visible'}\n"[m
[32m+[m[32m                  "â€¢ Some devices hide their names for privacy",[m
[32m+[m[32m                  style: TextStyle(fontSize: 12),[m
[32m+[m[32m                ),[m
[32m+[m[32m              ),[m
[32m+[m[41m              [m
[32m+[m[32m              if (advertisementData.serviceUuids.isNotEmpty) ...[[m
[32m+[m[32m                SizedBox(height: 8),[m
[32m+[m[32m                Text("Service UUIDs:", style: TextStyle(fontWeight: FontWeight.bold)),[m
[32m+[m[32m                ...advertisementData.serviceUuids.map((uuid) =>[m[41m [m
[32m+[m[32m                  Padding([m
[32m+[m[32m                    padding: EdgeInsets.only(left: 16, top: 2),[m
[32m+[m[32m                    child: Text(uuid.toString(), style: TextStyle(fontSize: 12, fontFamily: 'monospace')),[m
[32m+[m[32m                  )[m
[32m+[m[32m                ),[m
[32m+[m[32m              ],[m
[32m+[m[41m              [m
[32m+[m[32m              if (advertisementData.manufacturerData.isNotEmpty) ...[[m
[32m+[m[32m                SizedBox(height: 8),[m
[32m+[m[32m                Text("Manufacturer Data:", style: TextStyle(fontWeight: FontWeight.bold)),[m
[32m+[m[32m                ...advertisementData.manufacturerData.entries.map((entry) =>[m[41m [m
[32m+[m[32m                  Padding([m
[32m+[m[32m                    padding: EdgeInsets.only(left: 16, top: 2),[m
[32m+[m[32m                    child: Text("0x${entry.key.toRadixString(16).toUpperCase()}: ${entry.value}",[m[41m [m
[32m+[m[32m                               style: TextStyle(fontSize: 12, fontFamily: 'monospace')),[m
[32m+[m[32m                  )[m
[32m+[m[32m                ),[m
[32m+[m[32m              ],[m
[32m+[m[41m              [m
[32m+[m[32m              if (advertisementData.serviceData.isNotEmpty) ...[[m
[32m+[m[32m                SizedBox(height: 8),[m
[32m+[m[32m                Text("Service Data:", style: TextStyle(fontWeight: FontWeight.bold)),[m
[32m+[m[32m                ...advertisementData.serviceData.entries.map((entry) =>[m[41m [m
[32m+[m[32m                  Padding([m
[32m+[m[32m                    padding: EdgeInsets.only(left: 16, top: 2),[m
[32m+[m[32m                    child: Text("${entry.key}: ${entry.value}",[m[41m [m
[32m+[m[32m                               style: TextStyle(fontSize: 12, fontFamily: 'monospace')),[m
[32m+[m[32m                  )[m
[32m+[m[32m                ),[m
[32m+[m[32m              ],[m
[32m+[m[32m            ],[m
[32m+[m[32m          ),[m
[32m+[m[32m        ),[m
[32m+[m[32m        actions: [[m
[32m+[m[32m          TextButton([m
[32m+[m[32m            onPressed: () => Navigator.pop(context),[m
[32m+[m[32m            child: Text("Close"),[m
[32m+[m[32m          ),[m
[32m+[m[32m          if (advertisementData.connectable)[m
[32m+[m[32m            ElevatedButton([m
[32m+[m[32m              onPressed: () {[m
[32m+[m[32m                Navigator.pop(context);[m
[32m+[m[32m                connectToDevice(device);[m
[32m+[m[32m              },[m
[32m+[m[32m              child: Text("Connect"),[m
[32m+[m[32m            ),[m
[32m+[m[32m        ],[m
[32m+[m[32m      ),[m
[32m+[m[32m    );[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Widget _buildDetailRow(String label, String value) {[m
[32m+[m[32m    return Padding([m
[32m+[m[32m      padding: EdgeInsets.symmetric(vertical: 2),[m
[32m+[m[32m      child: Row([m
[32m+[m[32m        crossAxisAlignment: CrossAxisAlignment.start,[m
[32m+[m[32m        children: [[m
[32m+[m[32m          SizedBox([m
[32m+[m[32m            width: 80,[m
[32m+[m[32m            child: Text(label + ":", style: TextStyle(fontWeight: FontWeight.w500)),[m
[32m+[m[32m          ),[m
[32m+[m[32m          Expanded(child: Text(value, style: TextStyle(fontSize: 13))),[m
[32m+[m[32m        ],[m
[32m+[m[32m      ),[m
[32m+[m[32m    );[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Future<void> connectToDevice(BluetoothDevice device) async {[m
[32m+[m[32m    try {[m
[32m+[m[32m      // Show loading dialog[m
[32m+[m[32m      showDialog([m
[32m+[m[32m        context: context,[m
[32m+[m[32m        barrierDismissible: false,[m
[32m+[m[32m        builder: (context) => AlertDialog([m
[32m+[m[32m          content: Row([m
[32m+[m[32m            children: [[m
[32m+[m[32m              CircularProgressIndicator(),[m
[32m+[m[32m              SizedBox(width: 20),[m
[32m+[m[32m              Expanded(child: Text("Connecting to ${device.platformName}...")),[m
[32m+[m[32m            ],[m
[32m+[m[32m          ),[m
[32m+[m[32m        ),[m
[32m+[m[32m      );[m
[32m+[m
[32m+[m[32m      // Stop scanning before connecting[m
[32m+[m[32m      stopScanning();[m
[32m+[m
[32m+[m[32m      // Connect to the device[m
[32m+[m[32m      await device.connect(timeout: Duration(seconds: 15));[m
[32m+[m[41m      [m
[32m+[m[32m      // Close loading dialog[m
[32m+[m[32m      Navigator.pop(context);[m
[32m+[m[41m      [m
[32m+[m[32m      // Return to previous page with device info[m
[32m+[m[32m      Navigator.pop(context, {[m
[32m+[m[32m        'device': device,[m
[32m+[m[32m        'connected': true,[m
[32m+[m[32m      });[m
[32m+[m
[32m+[m[32m    } catch (e) {[m
[32m+[m[32m      // Close loading dialog[m
[32m+[m[32m      Navigator.pop(context);[m
[32m+[m[41m      [m
[32m+[m[32m      // Show error dialog[m
[32m+[m[32m      showDialog([m
[32m+[m[32m        context: context,[m
[32m+[m[32m        builder: (context) => AlertDialog([m
[32m+[m[32m          title: Text("Connection Failed"),[m
[32m+[m[32m          content: Text("Failed to connect to ${device.platformName}: $e"),[m
[32m+[m[32m          actions: [[m
[32m+[m[32m            TextButton([m
[32m+[m[32m              onPressed: () => Navigator.pop(context),[m
[32m+[m[32m              child: Text("OK"),[m
[32m+[m[32m            ),[m
[32m+[m[32m          ],[m
[32m+[m[32m        ),[m
[32m+[m[32m      );[m
[32m+[m[32m    }[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  Widget buildDeviceCard(ScanResult result) {[m
[32m+[m[32m    var device = result.device;[m
[32m+[m[32m    var rssi = result.rssi;[m
[32m+[m[32m    var advertisementData = result.advertisementData;[m
[32m+[m[41m    [m
[32m+[m[32m    // Try to get the best available name[m
[32m+[m[32m    String deviceName = "Unknown Device";[m
[32m+[m[32m    if (device.platformName.isNotEmpty) {[m
[32m+[m[32m      deviceName = device.platformName;[m
[32m+[m[32m    } else if (advertisementData.localName.isNotEmpty) {[m
[32m+[m[32m      deviceName = advertisementData.localName;[m
[32m+[m[32m    } else if (advertisementData.manufacturerData.isNotEmpty) {[m
[32m+[m[32m      // Try to identify by manufacturer data[m
[32m+[m[32m      var manufacturerData = advertisementData.manufacturerData;[m
[32m+[m[32m      if (manufacturerData.containsKey(0x004C)) {[m
[32m+[m[32m        deviceName = "Apple Device";[m
[32m+[m[32m      } else if (manufacturerData.containsKey(0x0006)) {[m
[32m+[m[32m        deviceName = "Microsoft Device";[m
[32m+[m[32m      } else if (manufacturerData.containsKey(0x00E0)) {[m
[32m+[m[32m        deviceName = "Google Device";[m
[32m+[m[32m      } else {[m
[32m+[m[32m        deviceName = "Device (Manufacturer: ${manufacturerData.keys.first.toRadixString(16).toUpperCase()})";[m
[32m+[m[32m      }[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    // Check if this might be a bike device[m
[32m+[m[32m    bool isPotentialBike = _isPotentialBike(result);[m
[32m+[m
[32m+[m[32m    // Get signal strength icon and color[m
[32m+[m[32m    IconData signalIcon;[m
[32m+[m[32m    Color signalColor;[m
[32m+[m[32m    if (rssi > -50) {[m
[32m+[m[32m      signalIcon = Icons.signal_cellular_4_bar;[m
[32m+[m[32m      signalColor = Colors.green;[m
[32m+[m[32m    } else if (rssi > -70) {[m
[32m+[m[32m      signalIcon = Icons.signal_cellular_alt;[m
[32m+[m[32m      signalColor = Colors.orange;[m
[32m+[m[32m    } else if (rssi > -85) {[m
[32m+[m[32m      signalIcon = Icons.signal_cellular_alt;[m
[32m+[m[32m      signalColor = Colors.orange;[m
[32m+[m[32m    } else {[m
[32m+[m[32m      signalIcon = Icons.signal_cellular_alt;[m
[32m+[m[32m      signalColor = Colors.red;[m
[32m+[m[32m    }[m
[32m+[m
[32m+[m[32m    return Card([m
[32m+[m[32m      margin: EdgeInsets.symmetric(horizontal: 16, vertical: 4),[m
[32m+[m[32m      color: isPotentialBike ? Colors.green.shade50 : null,[m
[32m+[m[32m      elevation: isPotentialBike ? 4 : 1,[m
[32m+[m[32m      child: ListTile([m
[32m+[m[32m        leading: CircleAvatar([m
[32m+[m[32m          backgroundColor: isPotentialBike ? Colors.green.shade100 : Colors.indigo.shade100,[m
[32m+[m[32m          child: Icon([m
[32m+[m[32m            isPotentialBike ? Icons.pedal_bike : Icons.bluetooth,[m
[32m+[m[32m            color: isPotentialBike ? Colors.green.shade800 : Colors.indigo.shade800,[m
[32m+[m[32m          ),[m
[32m+[m[32m        ),[m
[32m+[m[32m        title: Row([m
[32m+[m[32m          children: [[m
[32m+[m[32m            Expanded([m
[32m+[m[32m              child: Text([m
[32m+[m[32m                deviceName,[m
[32m+[m[32m                style: TextStyle([m
[32m+[m[32m                  fontWeight: FontWeight.bold,[m
[32m+[m[32m                  color: isPotentialBike ? Colors.green.shade800 : null,[m
[32m+[m[32m                ),[m
[32m+[m[32m              ),[m
[32m+[m[32m            ),[m
[32m+[m[32m            if (isPotentialBike)[m
[32m+[m[32m              Container([m
[32m+[m[32m                padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),[m
[32m+[m[32m                decoration: BoxDecoration([m
[32m+[m[32m                  color: Colors.green,[m
[32m+[m[32m                  borderRadius: BorderRadius.circular(10),[m
[32m+[m[32m                ),[m
[32m+[m[32m                child: Text([m
[32m+[m[32m                  "BIKE",[m
[32m+[m[32m                  style: TextStyle([m
[32m+[m[32m                    color: Colors.white,[m
[32m+[m[32m                    fontSize: 10,[m
[32m+[m[32m                    fontWeight: FontWeight.bold,[m
[32m+[m[32m                  ),[m
[32m+[m[32m                ),[m
[32m+[m[32m              ),[m
[32m+[m[32m          ],[m
[32m+[m[32m        ),[m
[32m+[m[32m        subtitle: Column([m
[32m+[m[32m          crossAxisAlignment: CrossAxisAlignment.start,[m
[32m+[m[32m          children: [[m
[32m+[m[32m            Text("ID: ${device.remoteId.toString().substring(0, 8)}...",[m[41m [m
[32m+[m[32m                 style: TextStyle(fontSize: 12)),[m
[32m+[m[32m            // Show platform name if different from displayed name[m
[32m+[m[32m            if (device.platformName.isNotEmpty && device.platformName != deviceName)[m
[32m+[m[32m              Text("Platform: ${device.platformName}",[m
[32m+[m[32m                   style: TextStyle(fontSize: 12, color: Colors.blue.shade700)),[m
[32m+[m[32m            // Show local name if different from displayed name[m
[32m+[m[32m            if (advertisementData.localName.isNotEmpty &&[m[41m [m
[32m+[m[32m                advertisementData.localName != deviceName)[m
[32m+[m[32m              Text("Local Name: ${advertisementData.localName}",[m
[32m+[m[32m                   style: TextStyle(fontSize: 12, color: Colors.purple.shade700)),[m
[32m+[m[32m            if (advertisementData.serviceUuids.isNotEmpty)[m
[32m+[m[32m              Text("Services: ${advertisementData.serviceUuids.length}",[m
[32m+[m[32m                   style: TextStyle(fontSize: 12)),[m
[32m+[m[32m            if (advertisementData.manufacturerData.isNotEmpty)[m
[32m+[m[32m              Text("Manufacturer: 0x${advertisementData.manufacturerData.keys.first.toRadixString(16).toUpperCase()}",[m
[32m+[m[32m                   style: TextStyle(fontSize: 12)),[m
[32m+[m[32m            // Show what names are actually being advertised[m
[32m+[m[32m            Text("Names: Platform='${device.platformName.isEmpty ? 'None' : device.platformName}', Local='${advertisementData.localName.isEmpty ? 'None' : advertisementData.localName}'",[m
[32m+[m[32m                 style: TextStyle(fontSize: 10, color: Colors.grey.shade600, fontStyle: FontStyle.italic)),[m
[32m+[m[32m            Row([m
[32m+[m[32m              children: [[m
[32m+[m[32m                Icon([m
[32m+[m[32m                  advertisementData.connectable ? Icons.link : Icons.link_off,[m
[32m+[m[32m                  size: 14,[m
[32m+[m[32m                  color: advertisementData.connectable ? Colors.green : Colors.red,[m
[32m+[m[32m                ),[m
[32m+[m[32m                SizedBox(width: 4),[m
[32m+[m[32m                Text([m
[32m+[m[32m                  advertisementData.connectable ? "Connectable" : "Not Connectable",[m
[32m+[m[32m                  style: TextStyle([m
[32m+[m[32m                    fontSize: 11,[m
[32m+[m[32m                    color: advertisementData.connectable ? Colors.green : Colors.red,[m
[32m+[m[32m                  ),[m
[32m+[m[32m                ),[m
[32m+[m[32m              ],[m
[32m+[m[32m            ),[m
[32m+[m[32m            if (isPotentialBike)[m
[32m+[m[32m              Text([m
[32m+[m[32m                "ðŸš´ Potential bike device",[m
[32m+[m[32m                style: TextStyle([m
[32m+[m[32m                  color: Colors.green.shade700,[m
[32m+[m[32m                  fontWeight: FontWeight.w500,[m
[32m+[m[32m                  fontSize: 12,[m
[32m+[m[32m                ),[m
[32m+[m[32m              ),[m
[32m+[m[32m          ],[m
[32m+[m[32m        ),[m
[32m+[m[32m        trailing: Column([m
[32m+[m[32m          mainAxisAlignment: MainAxisAlignment.center,[m
[32m+[m[32m          children: [[m
[32m+[m[32m            Icon(signalIcon, color: signalColor, size: 20),[m
[32m+[m[32m            Text("$rssi dBm", style: TextStyle(fontSize: 12)),[m
[32m+[m[32m          ],[m
[32m+[m[32m        ),[m
[32m+[m[32m        onTap: advertisementData.connectable[m[41m [m
[32m+[m[32m          ? () => connectToDevice(device)[m
[32m+[m[32m          : null,[m
[32m+[m[32m        onLongPress: () => showDeviceDetails(result),[m
[32m+[m[32m      ),[m
[32m+[m[32m    );[m
[32m+[m[32m  }[m
[32m+[m
[32m+[m[32m  @override[m
[32m+[m[32m  Widget build(BuildContext context) {[m
[32m+[m[32m    return Scaffold([m
[32m+[m[32m      appBar: AppBar([m
[32m+[m[32m        title: Text([m
[32m+[m[32m          "Select Device",[m
[32m+[m[32m          style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),[m
[32m+[m[32m        ),[m
[32m+[m[32m        backgroundColor: Colors.indigo.shade800,[m
[32m+[m[32m        iconTheme: IconThemeData(color: Colors.white),[m
[32m+[m[32m        actions: [[m
[32m+[m[32m          IconButton([m
[32m+[m[32m            icon: Icon(isScanning ? Icons.stop : Icons.refresh),[m
[32m+[m[32m            onPressed: isScanning ? stopScanning : startScanning,[m
[32m+[m[32m          ),[m
[32m+[m[32m        ],[m
[32m+[m[32m      ),[m
[32m+[m[32m      body: Container([m
[32m+[m[32m        decoration: const BoxDecoration([m
[32m+[m[32m          gradient: LinearGradient([m
[32m+[m[32m            colors: [[m
[32m+[m[32m              Color(0xFF3F51B5),[m
[32m+[m[32m              Color(0xFFC5CAE9),[m
[32m+[m[32m              Color(0xFFE8EAF6),[m
[32m+[m[32m            ],[m
[32m+[m[32m            begin: Alignment.topLeft,[m
[32m+[m[32m            end: Alignment.bottomRight,[m
[32m+[m[32m          ),[m
[32m+[m[32m        ),[m
[32m+[m[32m        child: Column([m
[32m+[m[32m          children: [[m
[32m+[m[32m            // Scanning status[m
[32m+[m[32m            Container([m
[32m+[m[32m              width: double.infinity,[m
[32m+[m[32m              padding: EdgeInsets.all(16),[m
[32m+[m[32m              child: Card([m
[32m+[m[32m                child: Padding([m
[32m+[m[32m                  padding: EdgeInsets.all(16),[m
[32m+[m[32m                  child: Row([m
[32m+[m[32m                    children: [[m
[32m+[m[32m                      if (isScanning)[m
[32m+[m[32m                        SizedBox([m
[32m+[m[32m                          width: 20,[m
[32m+[m[32m                          height: 20,[m
[32m+[m[32m                          child: CircularProgressIndicator(strokeWidth: 2),[m
[32m+[m[32m                        )[m
[32m+[m[32m                      else[m
[32m+[m[32m                        Icon(Icons.bluetooth_searching, color: Colors.indigo),[m
[32m+[m[32m                      SizedBox(width: 12),[m
[32m+[m[32m                      Expanded([m
[32m+[m[32m                        child: Text([m
[32m+[m[32m                          isScanning[m[41m [m
[32m+[m[32m                            ? "Scanning for devices... (${devices.length} found)"[m
[32m+[m[32m                            : "Found ${devices.length} device(s). Tap refresh to scan again.\nTap to connect â€¢ Long press for details\nðŸ“± Device names depend on what each device chooses to advertise",[m
[32m+[m[32m                          style: TextStyle(fontWeight: FontWeight.w500),[m
[32m+[m[32m                        ),[m
[32m+[m[32m                      ),[m
[32m+[m[32m                    ],[m
[32m+[m[32m                  ),[m
[32m+[m[32m                ),[m
[32m+[m[32m              ),[m
[32m+[m[32m            ),[m
[32m+[m[41m            [m
[32m+[m[32m            // Device list[m
[32m+[m[32m            Expanded([m
[32m+[m[32m              child: devices.isEmpty && !isScanning[m
[32m+[m[32m                ? Center([m
[32m+[m[32m                    child: Column([m
[32m+[m[32m                      mainAxisAlignment: MainAxisAlignment.center,[m
[32m+[m[32m                      children: [[m
[32m+[m[32m                        Icon([m
[32m+[m[32m                          Icons.bluetooth_disabled,[m
[32m+[m[32m                          size: 64,[m
[32m+[m[32m                          color: Colors.grey,[m
[32m+[m[32m                        ),[m
[32m+[m[32m                        SizedBox(height: 16),[m
[32m+[m[32m                        Text([m
[32m+[m[32m                          "No devices found",[m
[32m+[m[32m                          style: TextStyle([m
[32m+[m[32m                            fontSize: 18,[m
[32m+[m[32m                            color: Colors.grey.shade600,[m
[32m+[m[32m                          ),[m
[32m+[m[32m                        ),[m
[32m+[m[32m                        SizedBox(height: 8),[m
[32m+[m[32m                        Text([m
[32m+[m[32m                          "Make sure your bike is in pairing mode\nand tap refresh to scan again",[m
[32m+[m[32m                          textAlign: TextAlign.center,[m
[32m+[m[32m                          style: TextStyle([m
[32m+[m[32m                            color: Colors.grey.shade600,[m
[32m+[m[32m                          ),[m
[32m+[m[32m                        ),[m
[32m+[m[32m                      ],[m
[32m+[m[32m                    ),[m
[32m+[m[32m                  )[m
[32m+[m[32m                : ListView.builder([m
[32m+[m[32m                    itemCount: devices.length,[m
[32m+[m[32m                    itemBuilder: (context, index) {[m
[32m+[m[32m                      return buildDeviceCard(devices[index]);[m
[32m+[m[32m                    },[m
[32m+[m[32m                  ),[m
[32m+[m[32m            ),[m
[32m+[m[32m          ],[m
[32m+[m[32m        ),[m
[32m+[m[32m      ),[m
[32m+[m[32m    );[m
[32m+[m[32m  }[m
[32m+[m[32m}[m
[1mdiff --git a/macos/Flutter/GeneratedPluginRegistrant.swift b/macos/Flutter/GeneratedPluginRegistrant.swift[m
[1mindex 13c213c..809d2bc 100644[m
[1m--- a/macos/Flutter/GeneratedPluginRegistrant.swift[m
[1m+++ b/macos/Flutter/GeneratedPluginRegistrant.swift[m
[36m@@ -9,6 +9,7 @@[m [mimport cloud_firestore[m
 import file_selector_macos[m
 import firebase_core[m
 import firebase_messaging[m
[32m+[m[32mimport flutter_blue_plus_darwin[m
 import shared_preferences_foundation[m
 [m
 func RegisterGeneratedPlugins(registry: FlutterPluginRegistry) {[m
[36m@@ -16,5 +17,6 @@[m [mfunc RegisterGeneratedPlugins(registry: FlutterPluginRegistry) {[m
   FileSelectorPlugin.register(with: registry.registrar(forPlugin: "FileSelectorPlugin"))[m
   FLTFirebaseCorePlugin.register(with: registry.registrar(forPlugin: "FLTFirebaseCorePlugin"))[m
   FLTFirebaseMessagingPlugin.register(with: registry.registrar(forPlugin: "FLTFirebaseMessagingPlugin"))[m
[32m+[m[32m  FlutterBluePlusPlugin.register(with: registry.registrar(forPlugin: "FlutterBluePlusPlugin"))[m
   SharedPreferencesPlugin.register(with: registry.registrar(forPlugin: "SharedPreferencesPlugin"))[m
 }[m
[1mdiff --git a/pubspec.lock b/pubspec.lock[m
[1mindex 972aa24..b46658e 100644[m
[1m--- a/pubspec.lock[m
[1m+++ b/pubspec.lock[m
[36m@@ -49,6 +49,14 @@[m [mpackages:[m
       url: "https://pub.dev"[m
     source: hosted[m
     version: "2.13.0"[m
[32m+[m[32m  bluez:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: bluez[m
[32m+[m[32m      sha256: "61a7204381925896a374301498f2f5399e59827c6498ae1e924aaa598751b545"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "0.8.3"[m
   boolean_selector:[m
     dependency: transitive[m
     description:[m
[36m@@ -161,6 +169,14 @@[m [mpackages:[m
       url: "https://pub.dev"[m
     source: hosted[m
     version: "1.0.6"[m
[32m+[m[32m  dbus:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: dbus[m
[32m+[m[32m      sha256: "79e0c23480ff85dc68de79e2cd6334add97e48f7f4865d17686dd6ea81a47e8c"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "0.7.11"[m
   dio:[m
     dependency: "direct main"[m
     description:[m
[36m@@ -302,6 +318,54 @@[m [mpackages:[m
     description: flutter[m
     source: sdk[m
     version: "0.0.0"[m
[32m+[m[32m  flutter_blue_plus:[m
[32m+[m[32m    dependency: "direct main"[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus[m
[32m+[m[32m      sha256: bfae0d24619940516261045d8b3c74b4c80ca82222426e05ffbf7f3ea9dbfb1a[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "1.35.5"[m
[32m+[m[32m  flutter_blue_plus_android:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus_android[m
[32m+[m[32m      sha256: "9723dd4ba7dcc3f27f8202e1159a302eb4cdb88ae482bb8e0dd733b82230a258"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "4.0.5"[m
[32m+[m[32m  flutter_blue_plus_darwin:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus_darwin[m
[32m+[m[32m      sha256: f34123795352a9761e321589aa06356d3b53f007f13f7e23e3c940e733259b2d[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "4.0.1"[m
[32m+[m[32m  flutter_blue_plus_linux:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus_linux[m
[32m+[m[32m      sha256: "635443d1d333e3695733fd70e81ee0d87fa41e78aa81844103d2a8a854b0d593"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "3.0.2"[m
[32m+[m[32m  flutter_blue_plus_platform_interface:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus_platform_interface[m
[32m+[m[32m      sha256: a4bb70fa6fd09e0be163b004d773bf19e31104e257a4eb846b67f884ddd87de2[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "4.0.2"[m
[32m+[m[32m  flutter_blue_plus_web:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: flutter_blue_plus_web[m
[32m+[m[32m      sha256: "03023c259dbbba1bc5ce0fcd4e88b364f43eec01d45425f393023b9b2722cf4d"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "3.0.1"[m
   flutter_launcher_icons:[m
     dependency: "direct dev"[m
     description:[m
[36m@@ -556,26 +620,26 @@[m [mpackages:[m
     dependency: transitive[m
     description:[m
       name: leak_tracker[m
[31m-      sha256: "6bb818ecbdffe216e81182c2f0714a2e62b593f4a4f13098713ff1685dfb6ab0"[m
[32m+[m[32m      sha256: "8dcda04c3fc16c14f48a7bb586d4be1f0d1572731b6d81d51772ef47c02081e0"[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "10.0.9"[m
[32m+[m[32m    version: "11.0.1"[m
   leak_tracker_flutter_testing:[m
     dependency: transitive[m
     description:[m
       name: leak_tracker_flutter_testing[m
[31m-      sha256: f8b613e7e6a13ec79cfdc0e97638fddb3ab848452eff057653abd3edba760573[m
[32m+[m[32m      sha256: "1dbc140bb5a23c75ea9c4811222756104fbcd1a27173f0c34ca01e16bea473c1"[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "3.0.9"[m
[32m+[m[32m    version: "3.0.10"[m
   leak_tracker_testing:[m
     dependency: transitive[m
     description:[m
       name: leak_tracker_testing[m
[31m-      sha256: "6ba465d5d76e67ddf503e1161d1f4a6bc42306f9d66ca1e8f079a47290fb06d3"[m
[32m+[m[32m      sha256: "8d5a2d49f4a66b49744b23b018848400d23e54caf9463f4eb20df3eb8acb2eb1"[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "3.0.1"[m
[32m+[m[32m    version: "3.0.2"[m
   lints:[m
     dependency: transitive[m
     description:[m
[36m@@ -660,18 +724,18 @@[m [mpackages:[m
     dependency: "direct main"[m
     description:[m
       name: permission_handler[m
[31m-      sha256: "59adad729136f01ea9e35a48f5d1395e25cba6cea552249ddbe9cf950f5d7849"[m
[32m+[m[32m      sha256: bc917da36261b00137bbc8896bf1482169cd76f866282368948f032c8c1caae1[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "11.4.0"[m
[32m+[m[32m    version: "12.0.1"[m
   permission_handler_android:[m
     dependency: transitive[m
     description:[m
       name: permission_handler_android[m
[31m-      sha256: d3971dcdd76182a0c198c096b5db2f0884b0d4196723d21a866fc4cdea057ebc[m
[32m+[m[32m      sha256: "1e3bc410ca1bf84662104b100eb126e066cb55791b7451307f9708d4007350e6"[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "12.1.0"[m
[32m+[m[32m    version: "13.0.1"[m
   permission_handler_apple:[m
     dependency: transitive[m
     description:[m
[36m@@ -728,6 +792,14 @@[m [mpackages:[m
       url: "https://pub.dev"[m
     source: hosted[m
     version: "2.1.8"[m
[32m+[m[32m  rxdart:[m
[32m+[m[32m    dependency: transitive[m
[32m+[m[32m    description:[m
[32m+[m[32m      name: rxdart[m
[32m+[m[32m      sha256: "5c3004a4a8dbb94bd4bf5412a4def4acdaa12e12f269737a5751369e12d1a962"[m
[32m+[m[32m      url: "https://pub.dev"[m
[32m+[m[32m    source: hosted[m
[32m+[m[32m    version: "0.28.0"[m
   sanitize_html:[m
     dependency: transitive[m
     description:[m
[36m@@ -873,10 +945,10 @@[m [mpackages:[m
     dependency: transitive[m
     description:[m
       name: test_api[m
[31m-      sha256: fb31f383e2ee25fbbfe06b40fe21e1e458d14080e3c67e7ba0acfde4df4e0bbd[m
[32m+[m[32m      sha256: "522f00f556e73044315fa4585ec3270f1808a4b186c936e612cab0b565ff1e00"[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "0.7.4"[m
[32m+[m[32m    version: "0.7.6"[m
   typed_data:[m
     dependency: transitive[m
     description:[m
[36m@@ -889,10 +961,10 @@[m [mpackages:[m
     dependency: transitive[m
     description:[m
       name: vector_math[m
[31m-      sha256: "80b3257d1492ce4d091729e3a67a60407d227c27241d6927be0130c98e741803"[m
[32m+[m[32m      sha256: d530bd74fea330e6e364cda7a85019c434070188383e1cd8d9777ee586914c5b[m
       url: "https://pub.dev"[m
     source: hosted[m
[31m-    version: "2.1.4"[m
[32m+[m[32m    version: "2.2.0"[m
   vm_service:[m
     dependency: transitive[m
     description:[m
[1mdiff --git a/pubspec.yaml b/pubspec.yaml[m
[1mindex 5c37405..6c6492f 100644[m
[1m--- a/pubspec.yaml[m
[1m+++ b/pubspec.yaml[m
[36m@@ -33,7 +33,6 @@[m [mdependencies:[m
   curved_navigation_bar:[m
   animated_bottom_navigation_bar:[m
   google_maps_flutter:[m
[31m-  permission_handler:[m
   dio:[m
   flutter_polyline_points:[m
   flutter_stripe:[m
[36m@@ -45,6 +44,8 @@[m [mdependencies:[m
   firebase_core: ^4.0.0[m
   firebase_messaging: ^16.0.0[m
   cloud_firestore: ^6.0.0[m
[32m+[m[32m  flutter_blue_plus: ^1.35.5[m
[32m+[m[32m  permission_handler: ^12.0.1[m
   # The following adds the Cupertino Icons font to your application.[m
   # Use with the CupertinoIcons class for iOS style icons.[m
   cupertino_icons: ^1.0.8[m
